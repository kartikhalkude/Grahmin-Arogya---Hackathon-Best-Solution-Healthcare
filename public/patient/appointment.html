<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appointments - Synapse</title>
    <!-- Google Translate Script -->
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en",
            includedLanguages: "en,hi,mr,bn,te,ta,gu,kn,ml,pa,ur", // Indian languages
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
            autoDisplay: false,
          },
          "google_translate_element"
        );
      }
    </script>
    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="patient.css" />
  </head>
  <script src="/socket.io/socket.io.js"></script>
  <script src="patientscript.js"></script>
  <body>
    <div class="page-wrapper">
      <!-- Logo -->
      <div class="header-logo">
        <svg
          class="w-8 h-8"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <!-- Clean Medical Cross -->
          <rect
            x="4"
            y="4"
            width="16"
            height="16"
            rx="2"
            fill="#dc2626"
            class="text-red-600"
          />
          <path
            d="M12 8v8M8 12h8"
            stroke="white"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
        <span> &nbsp;ग्रामीण-आरोग्य</span>
      </div>

      <!-- Header -->
      <header class="header">
        <div class="header-container">
          <div class="header-actions">
            <!-- Add Google Translate Element -->
            <div id="google_translate_element"></div>
            <button onclick="logout()" class="flex items-center gap-2">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <a href="/patient.html" class="nav-link" id="dashboard-link">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a
            href="/patient/pbookap.html"
            class="nav-link"
            id="appointments-link"
          >
            <i class="fas fa-calendar-alt"></i>
            <span>Book Appointment</span>
          </a>
          <a href="/patient/ai.html" class="nav-link" id="ai-link">
            <i class="fas fa-robot"></i>
            <span>AI Prescription</span>
          </a>
          <a
            href="./prescription.html"
            class="nav-link"
            id="prescriptions-link"
          >
            <i class="fas fa-file-medical"></i>
            <span>Prescriptions</span>
          </a>
          <a
            href="appointment.html"
            class="nav-link"
            id="view-appointments-link"
          >
            <i class="fas fa-clock"></i>
            <span>Appointments</span>
          </a>
          <a
            href="scheme.html"
            id="view-schemes-link"
            class="nav-link"
            class="nav-link"
          >
            <i class="fas fa-hand-holding-medical w-6"></i>
            <span class="ml-2">Health Schemes</span>
          </a>
          <a
            href="health-monitor.html"
            id="health-monitor-link"
            class="nav-link"
          >
            <i class="fas fa-heartbeat w-6"></i>
            <span class="ml-2">Health Monitor</span>
          </a>
          <a
            href="medical-records.html"
            id="medical-records-link"
            class="nav-link"
          >
            <i class="fas fa-notes-medical"></i>
            <span>Medical Records</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="content-container">
          <div
            class="appointment-section bg-white rounded-lg shadow-sm p-6 mt-6"
          >
            <form style="display: none" id="appointmentForm" class="space-y-4">
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700"
                  >Select Doctor:</label
                >
                <select
                  id="appointmentDoctorSelect"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                >
                  <option value="">Choose a doctor...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700"
                  >Date:</label
                >
                <input
                  type="date"
                  id="appointmentDate"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  min=""
                />
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700"
                  >Time:</label
                >
                <select
                  id="appointmentTime"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                >
                  <option value="">Select time...</option>
                  <option value="09:00">09:00 AM</option>
                  <option value="09:30">09:30 AM</option>
                  <option value="10:00">10:00 AM</option>
                  <option value="10:30">10:30 AM</option>
                  <option value="11:00">11:00 AM</option>
                  <option value="11:30">11:30 AM</option>
                  <option value="14:00">02:00 PM</option>
                  <option value="14:30">02:30 PM</option>
                  <option value="15:00">03:00 PM</option>
                  <option value="15:30">03:30 PM</option>
                  <option value="16:00">04:00 PM</option>
                  <option value="16:30">04:30 PM</option>
                </select>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700"
                  >Notes (Optional):</label
                >
                <textarea
                  id="appointmentNotes"
                  rows="3"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  placeholder="Any additional notes for the doctor..."
                ></textarea>
              </div>

              <button
                type="submit"
                class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors"
              >
                Book Appointment
              </button>
            </form>

            <div class="mt-8">
              <div
                style="
                  background: linear-gradient(135deg, #4a90e2 0%, #9013fe 100%);
                  border-radius: 0.5rem;
                  padding: 30px;
                  color: white;
                  margin-bottom: 2rem;
                  text-align: center;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-direction: column;
                "
              >
                <h1 style="font-size: 1.875rem; font-weight: bold">
                  <span style="color: #eee7bc">Your Appointments</span>
                  <span id="welcomeName" style="color: #00e676"></span>
                </h1>
              </div>
              <div id="appointmentsList" class="space-y-4">
                <!-- Appointments will be listed here -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Appointment Details Modal -->
    <div
      id="appointmentModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Appointment Details</h3>
          <button
            onclick="closeAppointmentModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            ✕
          </button>
        </div>
        <div id="appointmentDetails" class="space-y-4"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Get current page path
        const currentPath = window.location.pathname;

        // Remove 'active' class from all links
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });

        // Add 'active' class based on current page
        if (currentPath.includes("patient.html")) {
          document.getElementById("dashboard-link").classList.add("active");
        } else if (currentPath.includes("pbookap.html")) {
          document.getElementById("appointments-link").classList.add("active");
        } else if (currentPath.includes("ai.html")) {
          document.getElementById("ai-link").classList.add("active");
        } else if (currentPath.includes("prescription.html")) {
          document.getElementById("prescriptions-link").classList.add("active");
        } else if (currentPath.includes("appointment.html")) {
          document
            .getElementById("view-appointments-link")
            .classList.add("active");
        } else if (currentPath.includes("scheme.html")) {
          document.getElementById("view-schemes-link").classList.add("active");
        }
      });
    </script>
    <script>
      let currentPatientName = "";

      document.addEventListener("DOMContentLoaded", () => {
        if (!sessionStorage.getItem("token")) {
          window.location.href = "/index.html";
          return;
        }
        loadPatientInfo();
        loadPrescriptions();
      });

      async function loadPatientInfo() {
        try {
          const response = await fetch("/api/patient/info", {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to fetch patient info");

          const data = await response.json();

          if (data && data.name) {
            currentPatientName = data.name;
            document.getElementById("patientName").textContent = data.name;
            document.getElementById("patientFullName").value = data.name;
            if (data.age) {
              document.getElementById("patientAge").value = data.age;
            }
          }
        } catch (error) {
          console.error("Error loading patient info:", error);
          document.getElementById("patientName").textContent = "Guest User";
        }
      }

      async function analyzeSymptoms() {
        const formData = {
          name:
            document.getElementById("patientFullName").value ||
            currentPatientName,
          age: document.getElementById("patientAge").value,
          language: document.getElementById("prescriptionLanguage").value,
          symptoms: document.getElementById("symptoms").value,
          duration: document.getElementById("duration").value,
          severity: document.getElementById("severity").value,
        };

        if (
          !formData.name ||
          !formData.age ||
          !formData.symptoms ||
          !formData.duration ||
          !formData.severity
        ) {
          alert("Please fill in all required fields before analyzing.");
          return;
        }

        // Show loading animation
        const loadingAnimation = document.getElementById("aiLoadingAnimation");
        loadingAnimation.style.display = "flex";

        const medicalPrompt = `
            Patient Name: ${formData.name}
            Age: ${formData.age}
            Symptoms: ${formData.symptoms}
            Duration: ${formData.duration}
            Severity: ${formData.severity}/10
            Preferred Language: ${formData.language}

            Provide the following in HTML format inside a <div> Dont add start html and bold the following:
            - Patient details
            - Diagnosis
            - Dos and Don'ts for the condition
            - Suggest 1-2 commonly used medicines

            Ensure it is formatted properly in ${formData.language}.
        `;

        try {
          const response = await puter.ai.chat(medicalPrompt);
          const aiDiagnosisBox = document.getElementById("aiDiagnosisBox");
          aiDiagnosisBox.innerHTML = response;
          aiDiagnosisBox.classList.remove("hidden");
          document
            .getElementById("submitSymptomsBtn")
            .classList.remove("hidden");
          sessionStorage.setItem("aiDiagnosis", response);
        } catch (error) {
          console.error("AI Analysis Error:", error);
          alert("Failed to analyze symptoms. Please try again.");
        } finally {
          // Hide loading animation
          loadingAnimation.style.display = "none";
        }
      }
      document
        .getElementById("symptomForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const selectedDoctor = document.getElementById("doctorSelect").value;
          if (!selectedDoctor) {
            alert("Please select a doctor");
            return;
          }

          const formData = {
            symptoms: document.getElementById("symptoms").value,
            duration: document.getElementById("duration").value,
            severity: parseInt(document.getElementById("severity").value),
            aiDiagnosis: sessionStorage.getItem("aiDiagnosis"),
            doctorId: selectedDoctor, // Add the selected doctor's ID
          };

          try {
            const response = await fetch("/api/prescriptions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionStorage.getItem("token")}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("Prescription request sent successfully!");
              sessionStorage.removeItem("aiDiagnosis");
              e.target.reset();
              document.getElementById("aiDiagnosisBox").classList.add("hidden");
              document
                .getElementById("submitSymptomsBtn")
                .classList.add("hidden");
              document.getElementById("doctorInfo").classList.add("hidden");
              loadPrescriptions();
            } else {
              throw new Error(
                data.error || "Failed to submit prescription request"
              );
            }
          } catch (error) {
            console.error("Submission Error:", error);
            alert(error.message);
          }
        });
      async function loadPrescriptions() {
        try {
          const response = await fetch("/api/prescriptions", {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to load prescriptions");

          const prescriptions = await response.json();
          displayPrescriptions(prescriptions);
        } catch (error) {
          console.error("Error loading prescriptions:", error);
          document.getElementById("prescriptionsList").innerHTML =
            '<p class="text-gray-600 text-center py-8">Failed to load prescriptions</p>';
        }
      }
      function displayPrescriptions(prescriptions) {
        const container = document.getElementById("prescriptionsList");

        if (!prescriptions || prescriptions.length === 0) {
          container.innerHTML =
            '<p class="text-gray-600 text-center py-8">No prescriptions available</p>';
          return;
        }

        container.innerHTML = prescriptions
          .map(
            (prescription) => `
        <div class="border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow bg-white" data-prescription-id="${
          prescription._id
        }">
            <div class="space-y-3">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="font-bold text-gray-900">Patient: ${currentPatientName}</div>
                    <div class="text-sm text-gray-600">Doctor: ${
                      prescription.doctorId?.name || "Pending Assignment"
                    }</div>
                </div>
                
                <div class="text-sm text-gray-500 mb-2">
                    Created: ${new Date(
                      prescription.createdAt
                    ).toLocaleString()}
                </div>
                
                <div class="flex items-center justify-between mt-4">
                    <div class="text-sm font-medium ${getStatusColor(
                      prescription.status
                    )}">
                        Status: ${
                          prescription.status.charAt(0).toUpperCase() +
                          prescription.status.slice(1)
                        }
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="showPrescriptionDetails('${
                              prescription._id
                            }')" 
                            class="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors duration-200">
                            View Details
                        </button>
                        ${
                          prescription.status === "pending"
                            ? `<button 
                                onclick="deletePrescription('${prescription._id}')"
                                class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors duration-200">
                                Delete
                            </button>`
                            : ""
                        }
                    </div>
                </div>
            </div>
        </div>
    `
          )
          .join("");
      }

      async function showPrescriptionDetails(prescriptionId) {
        try {
          const response = await fetch(`/api/prescriptions/${prescriptionId}`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok)
            throw new Error("Failed to fetch prescription details");

          const prescription = await response.json();

          const detailsHTML = `
            <div class="prescription-details">
                <h2 class="text-xl font-bold mb-4">Prescription Details</h2>
                <div class="space-y-2">
                    <p><strong>Patient:</strong> ${
                      prescription.patientId?.name || "Unassigned"
                    }</p>
                    <p><strong>Doctor:</strong> ${
                      prescription.doctorId?.name || "Unassigned"
                    }</p>
                    <p><strong>Created:</strong> ${new Date(
                      prescription.createdAt
                    ).toLocaleString()}</p>
                    
                    <div class="mt-4">
                        <strong>AI Diagnosis:</strong>
                        <p class="text-gray-700">${
                          prescription.aiDiagnosis || "No AI Analysis Available"
                        }</p>
                    </div>
                    
                    ${
                      prescription.medications &&
                      prescription.medications.length > 0
                        ? `<h3 class="mt-4 font-semibold">Medications:</h3>
                           <ul class="list-disc pl-5">
                               ${prescription.medications
                                 .map(
                                   (med) =>
                                     `<li>${med.name} - ${med.dosage} (${med.frequency})</li>`
                                 )
                                 .join("")}
                           </ul>`
                        : "<p>No medications prescribed</p>"
                    }
                    
                    ${
                      prescription.doctorNotes
                        ? `<h3 class="mt-4 font-semibold">Doctor's Notes:</h3>
                           <p>${prescription.doctorNotes}</p>`
                        : ""
                    }
                </div>
            </div>
        `;

          openModal(detailsHTML);
        } catch (error) {
          console.error("Error fetching prescription details:", error);
          alert("Failed to load prescription details");
        }
      }
      function openModal(content) {
        const modal = document.getElementById("prescriptionModal");
        const modalContent = document.getElementById("modalContent");

        // Set content
        modalContent.innerHTML = content;

        // Show modal
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeModal() {
        const modal = document.getElementById("prescriptionModal");

        // Hide modal
        modal.classList.remove("flex");
        modal.classList.add("hidden");
      }

      // Event Listeners for Modal
      document.addEventListener("DOMContentLoaded", () => {
        const closeModalBtn = document.getElementById("closeModalBtn");
        const modal = document.getElementById("prescriptionModal");

        // Close modal when close button clicked
        closeModalBtn.addEventListener("click", closeModal);

        // Close modal when clicking outside the modal content
        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        // Close modal with Escape key
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && !modal.classList.contains("hidden")) {
            closeModal();
          }
        });
      });

      function getStatusColor(status) {
        const colors = {
          pending: "text-yellow-600",
          approved: "text-green-600",
          rejected: "text-red-600",
        };
        return colors[status.toLowerCase()] || "text-gray-600";
      }

      async function deletePrescription(prescriptionId) {
        if (
          !confirm("Are you sure you want to delete this prescription request?")
        )
          return;

        try {
          const response = await fetch(`/api/prescriptions/${prescriptionId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to delete prescription");
          }

          alert("Prescription request deleted successfully");
          await loadPrescriptions();
        } catch (error) {
          console.error("Error deleting prescription:", error);
          alert(error.message);
        }
      }

      function downloadPrescription(prescriptionId) {
        // Note: This is a placeholder for future implementation
        // Could use libraries like jsPDF to generate downloadable prescriptions
        alert("Download feature coming soon!");
      }

      function logout() {
        sessionStorage.removeItem("token");
        window.location.href = "/index.html";
      }
    </script>
    <script>
      // Add these functions to your existing JavaScript
      async function loadDoctors() {
        try {
          const response = await fetch("/api/doctors", {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to fetch doctors");

          const doctors = await response.json();
          const doctorSelect = document.getElementById("doctorSelect");

          doctors.forEach((doctor) => {
            const option = document.createElement("option");
            option.value = doctor._id;
            option.textContent = `Dr. ${doctor.name} (${doctor.specialization})`;
            option.dataset.specialization = doctor.specialization;
            doctorSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading doctors:", error);
          alert("Failed to load available doctors");
        }
      }

      // Add doctor selection change handler
      document
        .getElementById("doctorSelect")
        .addEventListener("change", (e) => {
          const doctorInfo = document.getElementById("doctorInfo");
          const doctorSpecialization = document.getElementById(
            "doctorSpecialization"
          );

          if (e.target.value) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            doctorSpecialization.textContent =
              selectedOption.dataset.specialization;
            doctorInfo.classList.remove("hidden");
          } else {
            doctorInfo.classList.add("hidden");
          }
        });

      // Modify the existing submit handler

      // Call loadDoctors when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        if (!sessionStorage.getItem("token")) {
          window.location.href = "/index.html";
          return;
        }
        loadPatientInfo();
        loadPrescriptions();
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("appointmentDate").min = today;
        loadAppointments();
      });

      // Load doctors into the appointment doctor select
      async function loadAppointmentDoctors() {
        try {
          const response = await fetch("/api/doctors", {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to fetch doctors");

          const doctors = await response.json();
          const doctorSelect = document.getElementById(
            "appointmentDoctorSelect"
          );

          doctorSelect.innerHTML =
            '<option value="">Choose a doctor...</option>';
          doctors.forEach((doctor) => {
            const option = document.createElement("option");
            option.value = doctor._id;
            option.textContent = `Dr. ${doctor.name} (${doctor.specialization})`;
            doctorSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading doctors:", error);
          alert("Failed to load available doctors");
        }
      }

      // Handle appointment form submission
      document
        .getElementById("appointmentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            doctorId: document.getElementById("appointmentDoctorSelect").value,
            date: document.getElementById("appointmentDate").value,
            time: document.getElementById("appointmentTime").value,
            notes: document.getElementById("appointmentNotes").value,
          };

          try {
            const response = await fetch("/api/appointments", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionStorage.getItem("token")}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("Appointment booked successfully!");
              e.target.reset();
              loadAppointments();
            } else {
              throw new Error(data.error || "Failed to book appointment");
            }
          } catch (error) {
            console.error("Error booking appointment:", error);
            alert(error.message);
          }
        });

      // Load and display appointments
      async function loadAppointments() {
        try {
          const response = await fetch("/api/patient/appointments", {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to fetch appointments");

          const appointments = await response.json();

          // Sort appointments by date and time in descending order
          appointments.sort((a, b) => {
            const dateA = new Date(a.date + " " + a.time);
            const dateB = new Date(b.date + " " + b.time);
            return dateB - dateA;
          });

          const container = document.getElementById("appointmentsList");

          if (appointments.length === 0) {
            container.innerHTML =
              '<p class="text-gray-500 text-center py-4">No appointments found</p>';
            return;
          }

          container.innerHTML = appointments
            .map(
              (appointment) => `
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-semibold text-lg">Dr. ${
                    appointment.doctor.name
                  }</h3>
                  <p class="text-gray-600">${
                    appointment.doctor.specialization || "General Physician"
                  }</p>
                  <p class="text-gray-500 mt-2">
                    <i class="far fa-calendar"></i> ${new Date(
                      appointment.date
                    ).toLocaleDateString()}
                    <i class="far fa-clock ml-3"></i> ${appointment.time}
                  </p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm ${getStatusClass(
                  appointment.status
                )}">
                  ${
                    appointment.status.charAt(0).toUpperCase() +
                    appointment.status.slice(1)
                  }
                </span>
              </div>
              ${
                appointment.notes
                  ? `
                <div class="mt-3 pt-3 border-t">
                  <p class="text-gray-600"><i class="fas fa-notes-medical"></i> Notes: ${appointment.notes}</p>
                </div>
              `
                  : ""
              }
              ${
                appointment.attachments && appointment.attachments.length > 0
                  ? `
                <div class="mt-3 pt-3 border-t">
                  <h4 class="text-gray-700 font-medium mb-2">
                    <i class="fas fa-paperclip"></i> Attachments
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${appointment.attachments
                      .map(
                        (file) => `
                      <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                        <div class="flex items-center gap-2 flex-1 min-w-0 pr-4">
                          <i class="${getFileIcon(file.mimetype)}"></i>
                          <span class="text-sm text-gray-600 truncate" title="${
                            file.originalName
                          }">
                            ${file.originalName}
                          </span>
                        </div>
                        <div class="flex gap-3">
                          <button onclick="viewFile('${appointment._id}', '${
                          file.filename
                        }')" 
                            class="text-blue-600 hover:text-blue-800 p-1" 
                            title="View">
                            <i class="fas fa-eye"></i>
                          </button>
                          <button onclick="downloadFile('${
                            appointment._id
                          }', '${file.filename}', '${file.originalName}')"
                            class="text-green-600 hover:text-green-800 p-1"
                            title="Download">
                            <i class="fas fa-download"></i>
                          </button>
                          <button 
             onclick="window.location.href='http://localhost:4000'"
             class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
           >
             Join Call
           </button>
                        </div>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
              `
                  : ""
              }
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading appointments:", error);
          document.getElementById("appointmentsList").innerHTML =
            '<p class="text-gray-600">Failed to load appointments</p>';
        }
      }

      // Function to redirect to video call page
      function joinCall(appointmentId, doctorName) {
        // Encode parameters to handle special characters
        const encodedDoctorName = encodeURIComponent(doctorName);
        // Redirect to videocall.html with appointment ID and doctor name as parameters
        window.location.href = `http://localhost:4000/index.html`;
      }

      // Helper function to get status color classes
      function getStatusClass(status) {
        const classes = {
          scheduled: "bg-green-100 text-green-800",
          completed: "bg-blue-100 text-blue-800",
          cancelled: "bg-red-100 text-red-800",
        };
        return classes[status] || "bg-gray-100 text-gray-800";
      }

      // Add loadAppointmentDoctors to the existing DOMContentLoaded event listener
      document.addEventListener("DOMContentLoaded", () => {
        if (!sessionStorage.getItem("token")) {
          window.location.href = "/index.html";
          return;
        }
        loadPatientInfo();
        loadPrescriptions();
        loadAppointmentDoctors(); // Add this line
        loadAppointments(); // Add this line
      });
    </script>
    <script>
      function displayAppointments(appointments) {
        const container = document.getElementById("appointmentsList");
        container.innerHTML = "";

        appointments.forEach((appointment) => {
          const card = document.createElement("div");
          card.className = "bg-white rounded-lg shadow-sm p-6 mb-4";

          const header = document.createElement("div");
          header.className = "flex justify-between items-start mb-4";

          const doctorInfo = document.createElement("div");
          doctorInfo.innerHTML = `
            <h3 class="text-xl font-semibold">Dr. ${
              appointment.doctor.name
            }</h3>
            <p class="text-gray-600">${appointment.doctor.specialization}</p>
            <p class="text-gray-500 mt-1">
              ${new Date(appointment.date).toLocaleDateString()} at ${
            appointment.time
          }
            </p>
          `;

          const status = document.createElement("div");
          status.className = `px-3 py-1 rounded-full text-sm font-medium ${getStatusClass(
            appointment.status
          )}`;
          status.textContent =
            appointment.status.charAt(0).toUpperCase() +
            appointment.status.slice(1);

          header.appendChild(doctorInfo);
          header.appendChild(status);

          const content = document.createElement("div");
          content.className = "space-y-4";

          if (appointment.notes) {
            content.innerHTML += `
              <div>
                <h4 class="font-medium text-gray-700">Notes</h4>
                <p class="text-gray-600">${appointment.notes}</p>
              </div>
            `;
          }

          // Add attachments section if there are any
          if (appointment.attachments && appointment.attachments.length > 0) {
            const attachmentsSection = document.createElement("div");
            attachmentsSection.innerHTML = `
              <h4 class="font-medium text-gray-700 mb-2">Attachments</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                ${appointment.attachments
                  .map(
                    (attachment) => `
                  <div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                    <i class="${getFileIcon(attachment.mimetype)}"></i>
                    <span class="text-sm text-gray-600 truncate" title="${
                      attachment.originalName
                    }">
                      ${attachment.originalName}
                    </span>
                    <button 
                      onclick="viewFile('${appointment._id}', '${
                      attachment.filename
                    }')"
                      class="ml-auto text-blue-600 hover:text-blue-700"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                `
                  )
                  .join("")}
              </div>
            `;
            content.appendChild(attachmentsSection);
          }

          card.appendChild(header);
          card.appendChild(content);
          container.appendChild(card);
        });
      }

      function getStatusClass(status) {
        const classes = {
          scheduled: "bg-blue-100 text-blue-800",
          completed: "bg-green-100 text-green-800",
          cancelled: "bg-red-100 text-red-800",
        };
        return classes[status] || "bg-gray-100 text-gray-800";
      }

      function getFileIcon(mimetype) {
        if (mimetype.includes("pdf")) {
          return "fas fa-file-pdf text-red-500";
        } else if (mimetype.includes("image")) {
          return "fas fa-file-image text-green-500";
        } else if (mimetype.includes("word") || mimetype.includes("document")) {
          return "fas fa-file-word text-blue-500";
        }
        return "fas fa-file text-gray-500";
      }

      async function viewFile(appointmentId, filename) {
        try {
          const response = await fetch(
            `/api/appointments/${appointmentId}/attachments/${filename}`,
            {
              headers: {
                Authorization: `Bearer ${sessionStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to fetch file");
          }

          // Create a blob URL and open in new tab
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          window.open(url, "_blank");

          // Clean up the blob URL after opening
          setTimeout(() => window.URL.revokeObjectURL(url), 1000);
        } catch (error) {
          console.error("Error viewing file:", error);
          alert("Failed to view file. Please try again.");
        }
      }

      async function downloadFile(appointmentId, filename, originalName) {
        try {
          const response = await fetch(
            `/api/appointments/${appointmentId}/attachments/${filename}`,
            {
              headers: {
                Authorization: `Bearer ${sessionStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to fetch file");
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = originalName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // Clean up the blob URL
          setTimeout(() => window.URL.revokeObjectURL(url), 1000);
        } catch (error) {
          console.error("Error downloading file:", error);
          alert("Failed to download file. Please try again.");
        }
      }
    </script>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </body>
</html>
